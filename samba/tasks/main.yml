- name: package
  ansible.builtin.apt: { pkg: samba }
- name: user share
  ansible.builtin.user: { name: share, create_home: false }
- name: users system
  ansible.builtin.user: { name: "{{ item.key }}", create_home: false }
  loop: "{{ samba.users | dict2items }}"
- name: users samba
  samba: { name: "{{ item.key }}", password: "{{ item.value.password }}" }
  loop: "{{ samba.users | dict2items }}"
- name: share directories
  ansible.builtin.file: { path: "{{ item.value.path }}", state: directory, owner: "{{ user }}", group: "{{ user }}" }
  vars: { user: "{{ item.value.users[0] if item.value.users is defined and item.value.users | length == 1 else 'share' }}" }
  loop: "{{ samba.shares | dict2items }}"
- name: configuration
  ansible.builtin.template: { src: smb.conf, dest: /etc/samba/, validate: testparm --suppress-prompt %s }
  notify: restart samba
