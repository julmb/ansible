{% if system.configuration.address is defined %}
ListenAddress {{ system.configuration.address }}
{% endif %}
{% if system.configuration.port is defined %}
Port {{ system.configuration.port }}
{% endif %}

{% if system.configuration.password is defined %}
PasswordAuthentication {{ "yes" if system.configuration.password else "no" }}
{% endif %}

# TODO: we want to set the umask to 0002 for non-forced sftp sessions
# in debian, /etc/ssh/sshd_config already contains an sftp subsystem definition
# due to a bug, this cannot be overridden in a /etc/ssh/sshd_config.d/* file
# https://bugzilla.mindrot.org/show_bug.cgi?id=3236
# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=998834
# this is supposedly fixed in OpenSSH 9.5, until then, non-forced sftp sessions
# will use the default umask of 0022
# TODO: the umask has little effect to begin with
# even scp and sftp put will simply copy the file and then chmod it
# only sftp mkdir seems to be affected by the umask
# TODO: the chroot prevents access to /etc/passwd and /etc/group
# this causes no names to be displayed in the sftp client
# maybe we want to just drop the chroot entirely and adjust permissions on the other directories

{% if system.configuration.sftp is defined %}
{% for name, path in system.configuration.sftp.items() %}
Match Group {{ name }}
	DisableForwarding yes
	ForceCommand internal-sftp -u 0002
	ChrootDirectory {{ path }}
{% endfor %}
{% endif %}
