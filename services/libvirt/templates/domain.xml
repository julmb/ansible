<domain type="{{ domain.value.type }}">

  <name>{{ domain.key }}</name>
  <uuid>{{ domain.key | to_uuid }}</uuid>

  <os>
    <type arch="{{ domain.value.platform.architecture | default }}"
      machine="{{ domain.value.platform.chipset | default }}">hvm</type>
{% if domain.value.platform.uefi | default(false) %}
    <loader type="pflash" readonly="yes">/usr/share/OVMF/OVMF_CODE_4M.fd</loader>
{% endif %}
  </os>
  <features><acpi/></features>
  <pm><suspend-to-mem enabled="no"/><suspend-to-disk enabled="no"/></pm>

  <cpu mode="host-passthrough"/>
  <vcpu>{{ domain.value.hardware.cpus }}</vcpu>
  <memory unit="bytes">{{ domain.value.hardware.memory }}</memory>

  <devices>

{% for entry in domain.value.storage %}
    <disk type="{{ entry.type }}" device="{{ entry.device.type }}">
{% if entry.type == 'volume' %}
      <source pool="{{ entry.volume.pool }}" volume="{{ entry.volume.name }}"/>
{% elif entry.type == 'file' %}
      <source file="{{ entry.path }}"/>
{% endif %}
      <target dev="{{ entry.device.name }}" bus="{{ entry.device.bus }}"/>
{% if entry.device.boot is defined %}
      <boot order="{{ entry.device.boot }}"/>
{% endif %}
    </disk>
{% endfor %}

{% for entry in domain.value.interfaces %}
    <interface type="network">
      <mac address="{{ '52:54:00' | community.general.random_mac(seed = domain.key + '-' + loop.index | string) }}"/>
      <model type="{{ entry.type }}"/>
      <source network="{{ entry.network }}"/>
    </interface>
{% endfor %}

    <video><model type="virtio"/></video>
    <graphics type="spice" autoport="yes"/>

    <input type="tablet"/>

  </devices>

</domain>
